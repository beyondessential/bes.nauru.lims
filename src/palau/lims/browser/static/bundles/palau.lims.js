(()=>{"use strict";var e={311:e=>{e.exports=jQuery}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,i),o.exports}(()=>{var e=i(311);function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function n(e,i){for(var n=0;n<i.length;n++){var r=i[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(void 0,o=function(e,i){if("object"!==t(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!==t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(r.key),"symbol"===t(o)?o:String(o)),r)}var o}var r=[].indexOf;const o=function(){function t(){var i,n,o,s;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.is_required=this.is_required.bind(this),this.bind_event_handler=this.bind_event_handler.bind(this),this.on_template_selected=this.on_template_selected.bind(this),this.on_bottle_weight_change=this.on_bottle_weight_change.bind(this),this.on_bottle_container_blur=this.on_bottle_container_blur.bind(this),this.on_sample_type_selected=this.on_sample_type_selected.bind(this),this.get_sample_index=this.get_sample_index.bind(this),this.update_container=this.update_container.bind(this),this.toggle_container_visibility=this.toggle_container_visibility.bind(this),this.set_volume_readonly=this.set_volume_readonly.bind(this),this.calculate_volume=this.calculate_volume.bind(this),this.get_float_value=this.get_float_value.bind(this),this.round=this.round.bind(this),this.set_visible=this.set_visible.bind(this),this.fetch=this.fetch.bind(this),this.ajax_submit=this.ajax_submit.bind(this),this.get_portal_url=this.get_portal_url.bind(this),this.debug=this.debug.bind(this),this.get_add_controller=this.get_add_controller.bind(this),this.is_required()){if(this.debug("load"),this.sample_type_selector="div.uidreferencefield textarea[name^='SampleType']",this.template_selector="input[id^='Template']",this.bottle_weights_selector="input[id^='Bottles-'][id*='-Weight-']",this.bottle_containers_selector="input[id^='Bottles-'][id*='-Container-']",this.bind_event_handler(),r.call(document.body.classList,"template-ar_add")>=0)for(n=0,o=(s=document.querySelectorAll(this.sample_type_selector)).length;n<o;n++)i=s[n],e(i).trigger("select");else document.querySelector("div[data-fieldname='Bottles']")&&(i=document.querySelector("input[id='Volume']")).setAttribute("readonly","readonly");return this}}var i,o;return i=t,o=[{key:"is_required",value:function(){var e,t,i,n,r,o;for(o=["template-ar_add","portaltype-analysisrequest"],t=i=0,n=(r=document.body.classList).length;i<n;t=++i)if(e=r[t],o.includes(e))return!0;return!1}},{key:"bind_event_handler",value:function(){return this.debug("bind_event_handler"),e("body").on("SampleType:after_change",this.sample_type_selector,this.on_sample_type_selected),e("body").on("selected",this.template_selector,this.on_template_selected),e("body").on("blur",this.bottle_containers_selector,this.on_bottle_container_blur),e("body").on("change",this.bottle_weights_selector,this.on_bottle_weight_change)}},{key:"on_template_selected",value:function(t){var i,n,r;if(this.debug("on_template_selected"),i=t.currentTarget,n=this.get_sample_index(i),r=e("#".concat(i.id)).attr("uid"))return this.fetch(r,[]).done((function(e){var t;if(e)return t=e.SampleType_uid,this.update_container(n,t)}))}},{key:"on_bottle_weight_change",value:function(e){var t,i;return this.debug("on_bottle_weight_change"),t=e.currentTarget,i=this.get_sample_index(t),this.calculate_volume(i)}},{key:"on_bottle_container_blur",value:function(e){var t,i;return this.debug("on_bottle_container_blur"),t=e.currentTarget,i=this.get_sample_index(t),this.calculate_volume(i)}},{key:"on_sample_type_selected",value:function(e){var t,i;return this.debug("on_sample_type_selected"),t=e.currentTarget,i=this.get_sample_index(t),this.update_container(i,t.value)}},{key:"get_sample_index",value:function(t){var i;return this.debug("get_sample_index:element=".concat(t.id)),(i=t.closest("td[arnum]"))?e(i).attr("arnum"):null}},{key:"update_container",value:function(e,t){var i;return this.debug("update_container:sample_index=".concat(e,",sample_type_uid=").concat(t)),t?(i="ContainerWidget",this.fetch(t,i).done((function(t){var n;if(n=!1,t&&(n="container"===t[i]),this.toggle_container_visibility(e,n),this.set_volume_readonly(e,!n),!n)return this.calculate_volume(e)}))):(this.toggle_container_visibility(e,!0),this.set_volume_readonly(e,!1))}},{key:"toggle_container_visibility",value:function(e,t){return this.debug("toggle_container_visibility:sample_index=".concat(e,",show_container=").concat(t)),this.set_visible("Container",e,t),this.set_visible("Bottles",e,!t)}},{key:"set_volume_readonly",value:function(e,t){var i,n;return this.debug("set_volume_readonly:sample_index=".concat(e,",readonly=").concat(t)),n="#Volume",e&&(n="#Volume-".concat(e)),i=document.querySelector(n),t?i.setAttribute("readonly","readonly"):i.removeAttribute("readonly")}},{key:"calculate_volume",value:function(t){var i,n,r,o,s;return this.debug("calculate_volume:sample_index=".concat(t)),o=0,n="tr.records_row_Bottles",t&&(n="tr.records_row_Bottles-".concat(t)),i=document.querySelectorAll(n),r=this,e.each(i,(function(e,i){var n,s,l,a,u,c;return c="#Bottles-Weight-".concat(e),t&&(c="#Bottles-".concat(t,"-Weight-").concat(e)),u=i.querySelector(c),u=r.get_float_value(u),r.debug("Not a valid volume: ".concat(u)),s="#Bottles-DryWeight-".concat(e),t&&(s="#Bottles-".concat(t,"-DryWeight-").concat(e)),n=i.querySelector(s),n=r.get_float_value(n),r.debug("Not a valid volume: ".concat(n)),(l=u-n)<=0?(r.debug("Not a valid bottle volume: ".concat(l)),l=""):(l=r.round(1.05*l,3),o+=l),a="#Bottles-Volume-".concat(e),t&&(a="#Bottles-".concat(t,"-Volume-").concat(e)),i.querySelector(a).value=l})),o=parseFloat(o),(o=this.round(o,4))<=0?(this.debug("Not a valid volume: ".concat(o)),o=""):o+=" ml",s="#Volume",t&&(s="#Volume-".concat(t)),document.querySelector(s).value=o}},{key:"get_float_value",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t=parseFloat(e.value),isNaN(t)&&(t=parseFloat(i)),t}},{key:"round",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"set_visible",value:function(t,i,n){var r,o;return this.debug("set_visible:field_name=".concat(t,",sample_index=").concat(i,",visible=").concat(n)),o="div[data-fieldname='".concat(t,"']"),i&&(o="div[data-fieldname='".concat(t,"-").concat(i,"']")),"0"===i&&"1"===document.querySelector("#ar_count").value&&(o="tr[fieldname=".concat(t,"]")),r=document.querySelector(o),n?e(r).show():e(r).hide()}},{key:"fetch",value:function(t,i){var n,r;return this.debug("fetch:uid=".concat(t,",field_names=").concat(i)),n=e.Deferred(),r={url:this.get_portal_url()+"/@@API/read",data:{catalog_name:"senaite_catalog_setup",UID:t,include_fields:i,page_size:1}},this.ajax_submit(r).done((function(e){var t;return t={},e.objects&&(t=e.objects[0]),n.resolveWith(this,[t])})),n.promise()}},{key:"ajax_submit",value:function(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.debug("ajax_submit"),null==i.type&&(i.type="POST"),null==i.url&&(i.url=this.get_portal_url()),null==i.context&&(i.context=this),null==i.dataType&&(i.dataType="json"),null==i.data&&(i.data={}),null==i._authenticator&&(i._authenticator=e("input[name='_authenticator']").val()),this.debug(">>> ajax_submit::options=",i),e(this).trigger("ajax:submit:start"),t=function(){return e(this).trigger("ajax:submit:end")},e.ajax(i).done(t)}},{key:"get_portal_url",value:function(){return e("input[name=portal_url]").val()||window.portal_url}},{key:"debug",value:function(e){}},{key:"get_add_controller",value:function(){return window.bika.lims.AnalysisRequestAdd}}],o&&n(i.prototype,o),Object.defineProperty(i,"prototype",{writable:!1}),t}();var s=i(311),l=function(e,t){return function(){return e.apply(t,arguments)}};const a=function(){function e(){var e,t,i,n;if(this.debug=l(this.debug,this),this.init_sections_visibility=l(this.init_sections_visibility,this),this.init_toggle=l(this.init_toggle,this),this.on_toggle_selector_clicked=l(this.on_toggle_selector_clicked,this),this.is_required=l(this.is_required,this),this.is_required()){for(this.debug("load"),e=0,t=(n=[["#content h1","#senaite-sampleheader","png-lims-sample-header"],["#content h1","div[id=ar-attachments]","png-lims-sample-header"],["div.remarks-widget h3","div.remarks-widget div","png-lims-sample-remarks-section"],["div.analysis-listing-table h3","div.analysis-listing-table form","png-lims-sample-analyses-section"],["div[id=results-interpretation] h3","div[id=results-interpretation] form","png-lims-sample-results-interpretation-section"]]).length;e<t;e++)i=n[e],this.init_toggle(i[0],i[1],i[2]);return s("body").on("click",".toggle_selector",this.on_toggle_selector_clicked),this.init_sections_visibility(),this}}return e.prototype.is_required=function(){var e,t,i,n,r,o;for(o=["portaltype-analysisrequest"],t=i=0,n=(r=document.body.classList).length;i<n;t=++i)if(e=r[t],o.includes(e))return!0;return!1},e.prototype.on_toggle_selector_clicked=function(e){var t,i,n,r,o,l;for(this.debug("on_toggle_selector_clicked"),r=e.currentTarget.getAttribute("target-section"),t=0,i=(o=document.querySelectorAll("[section="+r+"]")).length;t<i;t++)n=o[t],(l=this.is_visible(n))?s(n).hide():s(n).show();return site.set_cookie(r,!l)},e.prototype.init_toggle=function(e,t,i){var n;return this.debug("init_toggle:anchor_selector='"+e+"',section_selector='"+t+"',section_id='"+i+"'"),(n=document.querySelector(e)).classList.add("toggle_selector"),n.setAttribute("target-section",i),document.querySelector(t).setAttribute("section",i)},e.prototype.is_visible=function(e){return"none"!==s(e).css("display")},e.prototype.init_sections_visibility=function(){var e,t,i,n,r,o,l,a;for(this.debug("set_visibility"),n=[],t=0,i=(e=document.querySelectorAll(".toggle_selector")).length;t<i;t++)o=e[t].getAttribute("target-section"),a=site.read_cookie(o)||"true",this.debug("section_id="+o+", visible="+a),a="true"===a,l=document.querySelectorAll("[section="+o+"]"),n.push(function(){var e,t,i;for(i=[],e=0,t=l.length;e<t;e++)r=l[e],a?i.push(s(r).show()):i.push(s(r).hide());return i}());return n},e.prototype.debug=function(e){},e}();var u=i(311),c=function(e,t){return function(){return e.apply(t,arguments)}};const _=function(){function e(){var e,t,i,n;if(this.on_reference_other_selector_change=c(this.on_reference_other_selector_change,this),this.bind_event_handler=c(this.bind_event_handler,this),this.is_required=c(this.is_required,this),this.is_required()){for(this.reference_other_selector="input.reference-otherfield-check",this.bind_event_handler(),t=0,i=(n=document.querySelectorAll(this.reference_other_selector)).length;t<i;t++)e=n[t],u(e).trigger("change");return this}}return e.prototype.is_required=function(){var e,t,i,n,r,o;for(o=["template-ar_add","portaltype-analysisrequest"],t=i=0,n=(r=document.body.classList).length;i<n;t=++i)if(e=r[t],o.includes(e))return!0;return!1},e.prototype.bind_event_handler=function(){return u("body").on("change",this.reference_other_selector,this.on_reference_other_selector_change)},e.prototype.on_reference_other_selector_change=function(e){var t,i,n;return t=e.currentTarget,n=u(t).attr("data_target"),i=document.querySelector("#"+n),t.checked?u(i).show():(u(i).hide(),u(i).val(""))},e}();document.addEventListener("DOMContentLoaded",(function(){window.sampletype_container=new o,window.sampleview_layout=new a,window.reference_other=new _}))})()})();